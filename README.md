# brave-resteasy-example #

Example RESTEasy service implementation that shows the use of the server side BravePreProcess / BravePostProcess interceptors 
and the usage of [brave](https://github.com/kristofa/brave) in general.

## What is it about? ##

On one hand there is the service resource which can be found in following class: 
com.github.kristofa.brave.resteasyexample.RestEasyExampleResource

Next to that there is an integration test: com.github.kristofa.brave.resteasyexample.ITRestEasyExample that sets up
an embedded Jetty server at port 8080 which deploys our service resource at context path http://localhost:8080/RestEasyTest.

The resource (RestEasyExampleResource) makes available 2 URI's

*   GET http://localhost:8080/RestEasyTest/brave-resteasy-example/a
*   GET http://localhost:8080/RestEasyTest/brave-resteasy-example/b


The test code (ITRestEasyExample) sets up our EndPoint, initializes a new trace/span using the Brave ClientTracer
and create a HTTP request to http://localhost:8080/RestEasyTest/brave-resteasy-example/a. The code that is triggered through
this URI will make a new call to the other URI: http://localhost:8080/RestEasyTest/brave-resteasy-example/b.

Because brave is set up the test results in 2 spans being logged. The test uses the logging SpanCollector which simply logs the spans through slf4j.

    16:00:10,309 INFO  [qtp149997662-16] brave.LoggingSpanCollectorImpl (LoggingSpanCollectorImpl.java:22) - [id: [trace id: 6124139389535523700, span id: 3631703637866094983, parent span id: 3801884886749338669], name: /brave-resteasy-example/b, annotations: [[annotation name: ss, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010309443000, duration: null], [annotation name: sr, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010226403000, duration: null]]]
    16:00:10,318 INFO  [qtp149997662-15] brave.LoggingSpanCollectorImpl (LoggingSpanCollectorImpl.java:22) - [id: [trace id: 6124139389535523700, span id: 3631703637866094983, parent span id: 3801884886749338669], name: brave-resteasy-example/b, annotations: [[annotation name: cs, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010214535000, duration: null], [annotation name: cr, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010318780000, duration: null], [annotation name: httpcode=200, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010318765000, duration: null]]]
    16:00:10,319 INFO  [qtp149997662-15] brave.LoggingSpanCollectorImpl (LoggingSpanCollectorImpl.java:22) - [id: [trace id: 6124139389535523700, span id: 3801884886749338669, parent span id: null], name: /brave-resteasy-example/a, annotations: [[annotation name: ss, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010319812000, duration: null], [annotation name: sr, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948009869961000, duration: null]]]
    16:00:10,320 INFO  [main] brave.LoggingSpanCollectorImpl (LoggingSpanCollectorImpl.java:22) - [id: [trace id: 6124139389535523700, span id: 3801884886749338669, parent span id: null], name: brave-resteasy-example/a, annotations: [[annotation name: cs, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948009622392000, duration: null], [annotation name: cr, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010320458000, duration: null], [annotation name: httpcode=200, end point: [ipv4: 2130706433, ip: 127.0.0.1, port: 8080, service name: RestEasyTest], timestamp: 1365948010320452000, duration: null]]]

The spans are logged in reverse order:

1  The last log line logs the client part of the first span the is initiated in the test code. 
   You notice that is has no parent spanid and it logs cs (client send), cr (client received) as well as the http code return code as annotations.
2  The 3rd log line logs the server part of the first span. So it has the same trace id, span id and null span id. 
   It logs sr (server received) and ss (server send) annotations.
3  The 2nd log line logs the client request from URI brave-resteasy-example/a to brave-resteasy-example/b. 
   It has the same trace id but different span id and refers to the our first span as parent span id. 
   As it is a client request it again logs cs, cr and http code annotations.
4  The 1st log line logs the server side part of brave-resteasy-example/b. 
   So it has sr and ss annotations and same trace information as previous span log.

So the 2 server side logs are generated by having BravePreProcessInterceptor and BravePostProcessInterceptor available.
The client side logs are generated by the code part of the service and the test.

## How is it all hooked together? ##

### src/main/webapp/WEB-INF/web.xml ###

We use Spring to wire everything together. Spring is set up in the web.xml

We use the Spring DispatcherServlet and choose to use annotation based configuration (AnnotationConfigWebApplicationContext) instead of
XML configuration.

We set up our context by scanning 2 packages (see contextConfigLocation init param):

*   com.github.kristofa.brave.resteasy : This package contains our Brave pre/post process interceptors. 
    As they are annotated with the Spring @Component annotation they will be picked up by Spring.
*   com.github.kristofa.brave.resteasyexample : This package contains our application resource but also dependency injection configuration 
    classes for:
  
    ClientTracer : Used in resources to configure trace information when doing new client requests.
    
    EndPointSubmitter : Used by Brave pre process interceptor.
    
    Resteasy : Loads springmvc-resteasy.xml which integrates resteasy with Spring.
    
    ServerTracer : Used by Brave pre and post process interceptors.
    
    SpanCollector : Used and shared by both ClientTracer and ServerTracer.
    
### Jetty ###

Jetty is embedded and started in the setup method of our test (ITRestEasyExample) and stopped in the tearDown method.

It is configured to use src/main/webapp/WEB-INF/web.xml so that is how Spring / Resteasy are being set up.

## Running it yourself ##

There is not release of Brave yet so you have to do:

    git clone https://github.com/kristofa/brave.git
    # In brave directory execute:
    mvn install # This will install snapshot releases of the brave artifacts into your local Maven repo.
    
    git clone https://github.com/kristofa/brave-resteasy-example.git
    # In brave-resteasy-example directory execute:
    mvn verify # This executes unit and integration tests and will execute ITRestEasyExample.


    

    